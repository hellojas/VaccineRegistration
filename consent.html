<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body onload='google.script.run.withSuccessHandler(onDocusignConnect).docusignConnect()'>
    <?var url = getScriptUrl();?>
    <a href='<?=url?>'>Home</a><br>
    <h1>Consent Form - Docusign</h1>
    TODO: Migrate from OAuth to JWT so it doesn't require Docusign account holder to be present.<br>
    TODO: consider PandaDoc integration as well which has a free unlimited eSign account<br>
    TODO: Send consent form for signature - email and then embedded <br>
    TODO: check consent form signature status - subscribe to completion <br>
    TODO: upload signed consent form to google drive with patient name<br><br><br>
    <div id="result"></div>
  </body>
  <script>
    function onDocusignConnect(result){
      console.log(result)

      if ('authUrl' in result) {
        html = `<a href=${result['authUrl']} target=new>Click to Login into Docusign</a>`
        document.getElementById("result").innerHTML = html
        return
      }

      // logout button    
      html = "<form onsubmit='google.script.run.logoutDocusign()' method='GET' action='<?=url?>'>"
      html += "<input hidden type='text' name='page' value='consent'>"
      html += "<button >Logout of Docusign</button></form><br>"

      // convert dict to table   
      html += '<table border=0>'
      var i = 0
      for(var key in result ){
        var color = (i%2==0) ? '#eee':'#fff'
        i += 1;
        html +=`<tr bgcolor=${color}><td><b>${key}:</b></td><td>${result[key]}</td></tr>`
      }
      html += '</table>'
      document.getElementById("result").innerHTML = html
    }
  </script>
</html>
