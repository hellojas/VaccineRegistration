<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
        <?var url = getScriptUrl();?>
    <a href='<?=url?>'>Home</a><br>
    <h1>Parse Barcode Test</h1>
    <form id="myform" 
    method="GET"
    action="<?=url?>"
    onsubmit="google.script.run.processCameraForm(this);">
      Photo of ID Card barcode on back:
      <input type="hidden" name="page" value="camera">
      <input name="ImageIDBack" type="file" accept="image/*" onchange="updatePhoto(this,1200)" capture="environment"><br>
      <canvas hidden id="canvas" width="0" height="0"></canvas><br>
      <button type="submit">Submit</button>
    </form>

<footer></footer> 
<script>

function detectBarcode(canvas) {
  if (window.BarcodeDetector == undefined) {
    var footer = document.getElementsByTagName('footer')[0];
    footer.innerHTML = "Barcode Detection not supported";
    console.error('Barcode Detection not supported');
    return;
  }

  var barcodeDetector = new BarcodeDetector();
  barcodeDetector.detect(canvas)
    .then(barcodes => {
      // Add the barcodes as strings to the <footer>
      console.log(barcodes);
      var footer = document.getElementsByTagName('footer')[0];
      footer.innerHTML = '<p>Detected ' + barcodes.length + ' barcodes</p>';
      for(var i = 0; i < barcodes.length; i++) {
        switch(barcodes[i].format) {
          case 'pdf417':
            res = parseDriversLicense(barcodes[i].rawValue)
            var footer = document.getElementsByTagName('footer')[0];
            html = "<table>"
            for(var k in res){
              html += "<tr><td>"+ k + "</td><td>"+res[k]+"</td></tr>"
            }
            html += "</table>"
            footer.innerHTML = html;
            break;
          default:
            footer.innerHTML += barcodes[i].format + ": " + barcodes[i].rawValue
            console.log(barcodes[i].format + ": " + barcodes[i].rawValue)

        }
      }  
    }).catch((e) => {
      var footer = document.getElementsByTagName('footer')[0];
      footer.innerHTML = "Barcode Detection failed: " + e;
      console.error("Barcode Detection failed: " + e);
    })
}

function updatePhoto(e, maxSize){
  resizeImage({
      file: e.files[0],
      maxSize: maxSize
  }).then(function (resizedImage) {
      console.log("resized image")
      var file = new File([resizedImage], e.files[0].name,
        {type:"image/jpeg", lastModified:new Date().getTime()});
      var container = new DataTransfer();
      container.items.add(file);
      e.files = container.files;
  }).catch(function (err) {
      console.error(err);
  });
}

var resizeImage = function (settings) {
    var file = settings.file;
    var maxSize = settings.maxSize;
    var reader = new FileReader();
    var image = new Image();
    var canvas = document.getElementById('canvas');
    var dataURItoBlob = function (dataURI) {
        var bytes = dataURI.split(',')[0].indexOf('base64') >= 0 ?
            atob(dataURI.split(',')[1]) :
            unescape(dataURI.split(',')[1]);
        var mime = dataURI.split(',')[0].split(':')[1].split(';')[0];
        var max = bytes.length;
        var ia = new Uint8Array(max);
        for (var i = 0; i < max; i++)
            ia[i] = bytes.charCodeAt(i);
        return new Blob([ia], { type: mime });
    };
    var resize = function () {
        var width = image.width;
        var height = image.height;
        if (width > height) {
            if (width > maxSize) {
                height *= maxSize / width;
                width = maxSize;
            }
        } else {
            if (height > maxSize) {
                width *= maxSize / height;
                height = maxSize;
            }
        }
        var origWidth = canvas.width
        var origHeight = canvas.height
        canvas.width = width;
        canvas.height = height;
        ctx = canvas.getContext('2d')
        ctx.drawImage(image, 0, 0, width, height);

        detectBarcode(canvas);

        var dataUrl = canvas.toDataURL('image/jpeg');
        var blob = dataURItoBlob(dataUrl);
        return blob;
    };
    return new Promise(function (ok, no) {
        if (!file.type.match(/image.*/)) {
            no(new Error("Not an image"));
            return;
        }
        reader.onload = function (readerEvent) {
            image.onload = function () { return ok(resize()); };
            image.src = readerEvent.target.result;
        };
        reader.readAsDataURL(file);
    });
};

driverLicenseFields={
'DAA': 'FullName',
'DAB': 'LastName',
'DAC': 'FirstName',
'DAD': 'MiddleName',
'DAE': 'NameSuffix',
'DAF': 'NamePrefix',
'DAG': 'AddressStreet1',
'DAH': 'AddressStreet2',
'DAI': 'AddressCity',
'DAJ': 'AddressState',
'DAK': 'AddressZip',
'DAL': 'AddressStreet1',
'DAM': 'AddressStreet2',
'DAN': 'AddressCity',
'DAO': 'AddressState',
'DAP': 'AddressZip',
'DAQ': 'LicenseorIDNumber',
'DAR': 'LicenseClassificationCode',
'DAS': 'LicenseRestrictionCode',
'DAT': 'LicenseEndorsementsCode',
'DAU': 'HeightinFT_IN',
'DAV': 'HeightinCM',
'DAW': 'WeightinLBS',
'DAX': 'WeightinKG',
'DAY': 'EyeColor',
'DAZ': 'HairColor',
'DBA': 'LicenseExpirationDate',
'DBB': 'DateofBirth',
'DBC': 'Sex',
'DBD': 'LicenseorIDDocumentIssueDate',
'DBE': 'IssueTimestamp',
'DBF': 'NumberofDuplicates',
'DBG': 'MedicalIndicatorCodes',
'DBH': 'OrganDonor',
'DBI': 'Non-ResidentIndicator',
'DBJ': 'UniqueCustomerIdentifier',
'DBK': 'SocialSecurityNumber',
'DBL': 'DateOfBirth',
'DBM': 'SocialSecurityNumber',
'DBN': 'FullName',
'DBO': 'LastName',
'DBO': 'FamilyName',
'DBP': 'FirstName',
'DBP': 'GivenName',
'DBQ': 'MiddleName',
'DBQ': 'MiddleNameorInitial',
'DBR': 'Suffix',
'DBS': 'Prefix',
'DCA': 'VirginiaSpecificClass',
'DCB': 'VirginiaSpecificRestrictions',
'DCD': 'VirginiaSpecificEndorsements',
'DCE': 'PhysicalDescriptionWeightRange',
'DCF': 'DocumentDiscriminator',
'DCG': 'Countryterritoryofissuance',
'DCH': 'FederalCommercialVehicleCodes',
'DCI': 'Placeofbirth',
'DCJ': 'Auditinformation',
'DCK': 'InventoryControlNumber',
'DCL': 'RaceEthnicity',
'DCM': 'Standardvehicleclassification',
'DCN': 'Standardendorsementcode',
'DCO': 'Standardrestrictioncode',
'DCP': 'Jurisdictionspecificvehicleclassificationdescription',
'DCQ': 'Jurisdiction-specific',
'DCR': 'Jurisdictionspecificrestrictioncodedescription',
'DCS': 'FamilyName',
'DCS': 'LastName',
'DCT': 'GivenName',
'DCT': 'FirstName',
'DCU': 'Suffix',
'DDA': 'ComplianceType',
'DDB': 'CardRevisionDate',
'DDC': 'HazMatEndorsementExpiryDate',
'DDD': 'LimitedDurationDocumentIndicator',
'DDE': 'FamilyNameTruncation',
'DDF': 'FirstNamesTruncation',
'DDG': 'MiddleNamesTruncation',
'DDH': 'Under18Until',
'DDI': 'Under19Until',
'DDJ': 'Under21Until',
'DDK': 'OrganDonorIndicator',
'DDL': 'VeteranIndicator',
'PAA': 'PermitClassificationCode',
'PAB': 'PermitExpirationDate',
'PAC': 'PermitIdentifier',
'PAD': 'PermitIssueDate',
'PAE': 'PermitRestrictionCode',
'PAF': 'PermitEndorsementCode',
'ZVA': 'CourtRestrictionCode'
}

function convertDateToHTML5Format(text){
  //convert mmddyyyy to yyyy-mm-dd
  return text.substring(text.length-4,text.length)+"-"+text.substring(0,2)+"-"+text.substring(2,4)
}

function convertAddressZipFormat(text){
  //convert zzzzzaaaa to zzzzz-aaaa
  return text.substring(0,5)+"-"+text.substring(5,text.length)
}
function convertGender(text){
  if(text == 2)
    return 'female'
  if(text == 1)
    return 'male'
  if(text == 'F')
    return 'female'
  if(text == 'M')
    return 'male'
  return 'other'
}
// use diversLicenseFields to parse decoded text, and return dictionary with matched entries
function parseDriversLicense(text){
  var parts = text.split('\n');
  var result = {}
  for(var i = 0; i < parts.length; i++) {
    var p = parts[i]
    var key = p.substring(0,3)
    var content = p.substring(3,p.length)
    if (key in driverLicenseFields) {
      var field = driverLicenseFields[key]
      if(field.includes("Date"))
        content = convertDateToHTML5Format(content);
      if(field.includes("AddressZip"))
        content = convertAddressZipFormat(content);
      if(field.includes("Sex"))
        content = convertGender(content);
      result[field] = content;
    }
  }
  return result;
}
  </script>


  </body>
</html>
