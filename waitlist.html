<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body onload="onLoad()">
    <?var url = getScriptUrl();?>
    <a href='<?=url?>'>Home</a><br>

     <form
     id="myform"
     onsubmit="google.script.run.processWaitlistForm(this)"
     method="GET"
     action="<?=url?>">
    <h1>Waitlist:</h1>
    <input type='text' name="page" hidden value='waitlist'>
    <table>
      <tr><td>CreatedBy: </td><td><input type='text' name="CreatedBy" required></td></tr>
      <tr><td>Patient First Name: </td><td><input type='text' name="FirstName" required></td></tr>
      <tr><td>Patient Last Name: </td><td><input type='text' name="LastName" required></td></tr>
      <tr><td>Patient Phone: </td><td><input type='text' name="Phone" required></td></tr>
      <tr><td>Patient Email: </td><td><input type='text' name="Email"></td></tr>
      <tr><td>Notes: </td><td><input type='text' name="Notes"></td></tr>
    </table>
    <button>Submit</button>
    <button type='button' onclick="generateTest()">Generate</button>
  </form>
  <br><br>
  <div id="waitlist"></div>
  </body>
  <script>

    function onLoad(){
      <?
      var createdBy = '';
      if ('CreatedBy' in urlParameters){
        createdBy = urlParameters['CreatedBy'];
      }
      ?>
      myform.CreatedBy.value = <?=createdBy?>;
      google.script.run.withSuccessHandler(onWaitlistData).getSheetDataAsDict('Waitlist')
    }

    function formatTimestamp(ts){
      var date = new Date(parseInt(ts));
      // Hours part from the timestamp
      var hours = date.getHours();
      // Minutes part from the timestamp
      var minutes = "0" + date.getMinutes();
      // Seconds part from the timestamp
      var seconds = "0" + date.getSeconds();

      var day = "0" + date.getDate();
      var month = "0" + (date.getMonth()+1);
      var year = date.getFullYear();

      // Will display time in 10:30:23 format
      var formattedTime =  year + "-" + month.substr(-2) + "-" + day.substr(-2) + " " + hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
      return formattedTime;
    }

    function formatPhone(n){
      return n.substr(0,3) + '-' + n.substr(3,3) + '-' + n.substr(6,n.length-6)
    }

    function onWaitlistData(results){
      console.log(results.length);

      html = '<table width=100%>';
      for(var i in results) {
        var color = (i%2==0) ? '#eee' : '#fff';
        var r = results[i]
        var ts = formatTimestamp(r['Timestamp'])
        var phone = formatPhone(r['Phone'])
        var firstName = r['FirstName'];
        var lastName = r['LastName'];
        var createdBy = r['CreatedBy'];
        var email = '';
        if ('Email' in r)
          email = r['Email']

        html += "<tr bgcolor='" + color + "'>";
        html += "<td>" + ts + "<br> CreatedBy:" + createdBy + "</td>";
        html += "<td>" + firstName + " " + lastName + "<br>"
        html += "<a href='tel:" + phone +"'>" + phone + "</a> " + email + "</td>";
        html += "<td> Status:<br>" + r['Status'] + "</td>";
        html += "<td> Begin CheckIn </td>";
        html += "</tr>";
      }
      html += "</table>"

      document.getElementById('waitlist').innerHTML = html;
    }

    function generateTest(){
        myform.FirstName.value = randomString(8);
        myform.LastName.value = randomString(8);
        myform.Phone.value = Math.floor(Math.random() * 10000000000);
        myform.Email.value = randomString(8)+'@'+randomString(8)+".com";
    }

    function randomString(length) {
      var result           = [];
      var characters       = 'abcdefghijklmnopqrstuvwxyz';
      var charactersLength = characters.length;
      for ( var i = 0; i < length; i++ ) {
        var c = characters.charAt(Math.floor(Math.random() * charactersLength))
        result.push(c);
      }
      return result.join('').toUpperCase();
    }
  </script>
</html>
