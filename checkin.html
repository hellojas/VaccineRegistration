<!DOCTYPE html>
<html>

<head>
	<base target="_top">
</head>

<body onload="onLoad()" style="font-family: sans-serif">
	<?var url = getScriptUrl();?>
	<a href='<?=url?>'>Home</a><br>
	<h1>Check-In (Staff Only)</h1>

  <table>
  <tr><td>
	  <b>Lot:</b> 
  </td><td>
    <select id='lot'>
      <option value='1'>1</option>
      <option value='2'>2</option>
    </select>
  </td></tr>  
  <tr><td>
    <b>Division:</b>
  </td><td>
    <select id='division'>
      <option value='A'>A</option>
      <option value='B'>B</option>
    </select>
  </td></tr>  
  </table>
  <br>

  Filter by day: 
  <select id='dateSelect' name='date' onchange='onDateSelect(this)'>
    <option value='all' selected>all</option>
  </select><br>

	<form id="myform">
		Search: <input type="text" id="query" onkeyup="onKeyUp(this)"><br>
		<? if(ENABLE_QR_CODE) {?>
		Scan QR code/ID barcode: <input type="file" accept="image/*"
      name="ImageIDBack" onchange="onImageChange(this,'canvas')" capture="environment">
		<canvas hidden id="canvas" width="0" height="0"></canvas>
		<?}?>
	</form>
	<br><br>
	<div id="results"></div>
</body>
<script>
	var data = null;
var days = {};
var appointmentsLUT = {};

function onKeyUp(e) {
  showMatches();
}

function convert24to12hr(time){
  //format time to 12hr
  hrs = parseInt(time.split(':')[0]);
  suffix = (hrs >= 12) ? " PM" : " AM";
  hrs = (hrs >= 13) ? hrs-12: hrs;
  return '' + hrs + ':' + time.split(':')[1] + suffix;
}

function convertDateToString(date){
  //format time to 12hr
  var parts = date.split('-')
  var year = parts[0];
  var month = parseInt(parts[1]);
  var day = parts[2];
  months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']
  return year + '-' + months[month-1] + '-'+day;
}

function onLoad(){

  <? if(appointmentData != null) {?>
    var res = []
    <? for(i in appointmentData){ ?>
      var a = <?!=JSON.stringify(appointmentData[i])?>;
      res.push(a);
    <?}?>
    onAppointmentData(res);
  <?}?>

  google.script.run.withSuccessHandler(onCheckInData).getCheckInDataset()

}

function onAppointmentData(results){
  var appointments = results
  //load appointments group by day and by name
  for (var i in appointments) {
    var appointment = appointments[i];
    var day = appointment['Date'];
    var name = appointment['Name'];
    if (!(day in days))
      days[day] = {}
    if (!(name in days[day]))
      days[day][name] = []
    days[day][name].push(appointment);
    appointmentsLUT[appointment['ID']] = appointment
  }

  // construct date drop down with availability
  var dateSelecter = document.getElementById("dateSelect");
  for (var day in days) {
    var option = document.createElement("option");
    option.text = convertDateToString(day);
    option.value = day;
    dateSelecter.add(option);
  }

  showMatches()
}

function onDateSelect(elem){
  showMatches()
}

function onCheckInData(result) {
  data = result
  showMatches();
}

function onSuccess(result){
//  console.log(result);
}

function showMatches() {
  if(data == null)
    return

  query = document.getElementById('query').value
  day = document.getElementById('dateSelect').value

  // all upper without whitespace
  query = query.toUpperCase().replace(' ','');
  var matches = []
  day = day.replaceAll('-','')

  // case insensitive first or last name search
  for(var i = 0; i < data.length; i++) {
    var lastName = data[i]['LastName'].toUpperCase();
    var firstName = data[i]['FirstName'].toUpperCase();
    var fullName = firstName + lastName;
    var id = data[i]['ID'].toUpperCase();

    var dayhit = false
    if((day != null)&&(day != 'all')) {
      var appointmentId = data[i]['Dose1AppointmentID']
      if(appointmentId != null){
        if(appointmentId.includes(day))
          dayhit = true
      }
      var appointmentId = data[i]['Dose2AppointmentID']
      if(appointmentId != null){
        if(appointmentId.includes(day))
          dayhit = true
      }
      // if day was select, must have a hit
      if(!dayhit)
        continue;
    }

    if (lastName.includes(query) || firstName.includes(query) || fullName.includes(query) || id.includes(query))
      matches.push(data[i]);
  }

  if(matches.length == 0) {
    html = 'No Results';
  }
  else {
    //sort by last name, then first
    matches.sort(function(a, b){
      var a2 = a.LastName.toUpperCase();
      var b2 = b.LastName.toUpperCase();
      if (a2 < b2) 
        return -1;
      if (a2 > b2) 
        return 1;

      a2 = a.FirstName.toUpperCase();
      b2 = b.FirstName.toUpperCase();
      if (a2 < b2) 
        return -1;
      if (a2 > b2) 
        return 1;
      return 0;
    });

    html = '';
    html += "<div><table width=100%><tr bgcolor='#ddf'>"
    html += "<td width=300><b>Name</b></td>"
    html += "<td><b>Profile</b></td>"

    // only show the first incomplete dose
    html += "<td><b>Date@Time:</b></td>";
    html += "<td><b>Dose:</b></td>";
    html += "<td><b>Brand:</b></td>";
    html += "<td><b>Consent:</b></td>";
    html += "<td><b>Status:</b></td>";
    html += "<td><b>Notes:</b></td>";
    html += "</tr>";

    for(var i in matches){
      var id =  matches[i]['ID'];
      var lastName = matches[i]['LastName'];
      var firstName = matches[i]['FirstName'];
      var status1 = matches[i]['Dose1Status'];
      var appointmentId1 = matches[i]['Dose1AppointmentID']
      var consent1url = matches[i]['Dose1ConsentUrl'];
      var consent1 = matches[i]['Dose1ConsentStatus'];
      var brand1 = matches[i]['Dose1VaccineBrand'];
      var notes = matches[i]['Notes'];

      if(notes == null)
        notes = ''

      var nameAppointmentUrl = `<a href='<?=url?>?page=appointments&ID=${id}' target=new>${lastName}, ${firstName}</a>`;
      var profileUrl = `<a href='<?=url?>?page=profile&ID=${id}' target=new>profile</a>`;

      if(consent1 == 'completed') {
        consent1 = `<a href='${consent1url}'>${consent1}</a>`
      } else {
        consent1 = `<button type='button' disabled>request</button>`        
      }

      if(status1 == null)
        status1 = ''

      if(consent1 == null)
        consent1 = ''

      if(brand1 == null)
        brand1 = ''

      var appointmentId2 = matches[i]['Dose2AppointmentID']
      var status2 = matches[i]['Dose2Status'];
      var consent2 = matches[i]['Dose2ConsentStatus'];
      var brand2 = matches[i]['Dose2VaccineBrand'];
      var consent2url = matches[i]['Dose2ConsentUrl'];


      if(consent2 == 'completed') {
        consent2 = `<a href='${consent2url}'>${consent2}</a>`
      } else {
        consent2 = `<button type='button' disabled>request</button>`        
      }

      if(status2 == null)
        status2 = ''

      if(consent2 == null)
        consent2 = ''

      if(brand2 == null)
        brand2 = ''

      // only show the first incomplete dose

      var appointmentId = appointmentId1
      var status = status1
      var brand = brand1
      var consent = consent1
      var dose = 1

      if(status1 == 'completed') {
        dose = 2
        appointmentId = appointmentId2
        status = status2
        brand = brand2
        consent = consent2
      }

      var bgcolor = (i%2 == 0) ? '#eeeeee' : '#ffffff';
      html += `<tr bgcolor="${bgcolor}" width=100% height=30>`
      html += `<td width=300>${nameAppointmentUrl}</td>`      
      html += `<td>${profileUrl}</td>`

      if(status=='registered') { // use status as checkin button
        status = `<div id='status${dose}_${id}'><button type='button' onclick="doCheckin('${id}','${appointmentId}',${dose})">${status}</button></div>`
      }
      var date = appointmentId // show ID by default, can occur if appointment not found
      if((date == null)||(date==''))
        date = `<button type='button' onclick="scheduleNow()" disabled>schedule now</button>`
      var appointment = appointmentsLUT[appointmentId]
      if(appointment != null){
        date = appointment['Date'] + "@" + appointment['Time']
      }


      html += `<td>${date}</td>`;
      html += `<td>${dose}</td>`;
      html += `<td>${brand}</td>`;
      html += `<td>${consent}</td>`;
      html += `<td>${status}</td>`;
      html += `<td>${notes}</td>`;
      html += "</tr>"
    } // for each match
    html += "</table>"
  } // no matches

  document.getElementById('results').innerHTML = html;
}

function scheduleNow(){
  console.log("schedule now not yet implemented")
}

function doCheckin(id, appointmentId, dose){
  var lot = document.getElementById('lot').value
  var division = document.getElementById('division').value
  console.log('checkin',id,appointmentId, dose, lot, division)
  var state = 'completed'

  //change google sheet data
  google.script.run.withSuccessHandler(onSuccess).processCheckIn(id, appointmentId, dose, lot, division)

  //change in memory data used by live update
  for(var i = 0; i < data.length; i++) {
    if(id == data[i]['ID'].toUpperCase()){
      data[i]['Dose'+dose+'Status'] = state
    }
  }

  //change current displayed HTML
  document.getElementById('status'+dose + "_"+id).innerHTML = 'completed'

}

// reads file into memory, draws scaled version to canvas, runs barcode detection on canvas, displays output
async function onImageChange(elem, canvasId){
  var canvas = document.getElementById(canvasId);
  await scaleImageToFit(elem,1000,canvas);
  var res =  await detectBarcode(canvas);
  if(res.status == 'success') {
    var barcode = res.barcodes[0]
    if (barcode.format == 'qr_code'){
       myform.query.value = barcode.value
    }
    if (barcode.format == 'pdf417'){
      myform.query.value = barcode.value.FirstName + ' ' + barcode.value.LastName;
    }
    showMatches(myform.query.value);
  }
}
</script>
<?!=HtmlService.createHtmlOutputFromFile('barcode.js').getContent()?>

</html>