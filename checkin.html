<!DOCTYPE html>
<html>

<head>
	<base target="_top">
</head>

<body onload="google.script.run.withSuccessHandler(onCheckInData).getCheckInDataset('2021-04-01')">
	<?var url = getScriptUrl();?>
	<a href='<?=url?>'>Home</a><br>
  <h1>Check-In (Staff Only)</h1>

  <!-- If staff session, show full profile, else limit. -->
  <? if (validateStaffSession()) {?>
    <form id="myform">
      Search: <input type="text" id="query" onkeyup="onKeyUp(this)"><br>
      Scan QR code/ID barcode: <input type="file" accept="image/*"
      name="ImageIDBack" onchange="onImageChange(this,'canvas')" capture="environment">
      <canvas hidden id="canvas" width="0" height="0"></canvas>
    </form>
    <br><br>
    <div id="results"></div>

    <?} else {?>
    Hi! This is a staff only page.<br>
    Please <a href='<?=url?>?page=login'>login</a></li> to access check-in or return home if you arrived here in error.
    <? } ?>

</body>
<script>
var data;

function onKeyUp(e) {
  showMatches(e.value);
}

function onCheckInData(result) {
  data = result
  console.log(data.length);
  showMatches('');
}

function onSuccess(result){
  console.log(result);
}

function showMatches(query) {

  // all upper without whitespace
  query = query.toUpperCase().replace(' ','');
  var matches = []

  // case insensitive first or last name search
  for(var i = 0; i < data.length; i++) {
    var lastName = data[i]['LastName'].toUpperCase();
    var firstName = data[i]['FirstName'].toUpperCase();
    var fullName = firstName + lastName;
    var id = data[i]['ID'].toUpperCase();

    // soft match on name?
    if (lastName.includes(query) || firstName.includes(query) || fullName.includes(query) || id.includes(query))
      matches.push(data[i]);
  }

  if(matches.length == 0) {
    html = 'No Results';
  }
  else {
    //sort by last name, then first
    matches.sort(function(a, b){
      var a2 = a.LastName.toUpperCase();
      var b2 = b.LastName.toUpperCase();
      if (a2 < b2) 
        return -1;
      if (a2 > b2) 
        return 1;

      a2 = a.FirstName.toUpperCase();
      b2 = b.FirstName.toUpperCase();
      if (a2 < b2) 
        return -1;
      if (a2 > b2) 
        return 1;
      return 0;
    });

    html = '';
    html += "<div><table width=100%><tr bgcolor='#ddf'>"
    html += "<td width=300>Name</td>"
    html += "<td>Full Profile</td>"
    html += "<td>Dose1Status:</td>";
    html += "<td>Dose1Consent:</td>";
    html += "<td>Dose1Brand:</td>";
    html += "<td>Dose2Status:</td>";
    html += "<td>Dose2Consent:</td>";
    html += "<td>Dose2Brand:</td>";
    html += "<td>Notes:</td>";
    html += "</tr>";

    for(var i in matches){
      var id =  matches[i]['ID'];
      var lastName = matches[i]['LastName'];
      var firstName = matches[i]['FirstName'];
      var status1 = matches[i]['Dose1Status'];
      var appointmentId1 = matches[i]['Dose1AppointmentID']
      var consent1url = matches[i]['Dose1ConsentUrl'];
      var consent1 = matches[i]['Dose1ConsentStatus'];
      var brand1 = matches[i]['Dose1VaccineBrand'];
      var notes = matches[i]['Notes'];


      if(notes == null)
        notes = ''

      var nameAppointmentUrl = `<a href='<?=url?>?page=appointments&ID=${id}'>${lastName}, ${firstName}</a>`;
      var profileUrl = `<a href='<?=url?>?page=profile&ID=${id}'>profile</a>`;

      if(consent1 == 'completed') {
        consent1 = `<a href='${consent1url}'>${consent1}</a>`
      }

      if(status1=='registered') { // allow cancelled people to still be checked in?
        status1 = `<div id='status1_${id}'><button type='button' onclick="doCheckin('${id}','${appointmentId1}',1)">${status1}</button></div>`
      }

      if(status1 == null)
        status1 = ''

      if(consent1 == null)
        consent1 = ''

      if(brand1 == null)
        brand1 = ''

      var appointmentId2 = matches[i]['Dose2AppointmentID']
      var status2 = matches[i]['Dose2Status'];
      var consent2 = matches[i]['Dose2ConsentStatus'];
      var brand2 = matches[i]['Dose2VaccineBrand'];
      var consent2url = matches[i]['Dose2ConsentUrl'];

      if(consent2 == 'completed') {
        consent2 = `<a href='${consent2url}'>${consent2}</a>`
      }

      if(status2 == null)
        status2 = ''

      if(status2=='registered') { // allow cancelled people to still be checked in?
        status2 = `<div id='status2_${id}'><button type='button' onclick="doCheckin('${id}','${appointmentId2}',2)">${status2}</button></div>`
      }

      if(consent2 == null)
        consent2 = ''

      if(brand2 == null)
        brand2 = ''

      var bgcolor = (i%2 == 0) ? '#eeeeee' : '#ffffff';
      html += `<tr bgcolor="${bgcolor}" width=100% height=30>`
      html += `<td width=300>${nameAppointmentUrl}</td>`
      html += `<td>${profileUrl}</td>`
      html += `<td>${status1}</td>`;
      html += `<td>${consent1}</td>`;
      html += `<td>${brand1}</td>`;
      html += `<td>${status2}</td>`;
      html += `<td>${consent2}</td>`;
      html += `<td>${brand2}</td>`;
      html += `<td>${notes}</td>`;
      html += "</tr>"
    } // for each match
    html += "</table>"
  } // no matches

  document.getElementById('results').innerHTML = html;
}

function doCheckin(id, appointmentId, dose){
  console.log(id,appointmentId, dose)
  var state = 'completed'
  //change google sheet data
  google.script.run.withSuccessHandler(onSuccess).processCheckIn(id, appointmentId, dose)

  //change in memory data used by live update
  for(var i = 0; i < data.length; i++) {
    if(id == data[i]['ID'].toUpperCase()){
      data[i]['Dose'+dose+'Status'] = state
    }
  }

  //change current displayed HTML
  document.getElementById('status'+dose + "_"+id).innerHTML = 'completed'

}

// reads file into memory, draws scaled version to canvas, runs barcode detection on canvas, displays output
async function onImageChange(elem, canvasId){
  var canvas = document.getElementById(canvasId);
  await scaleImageToFit(elem,1000,canvas);
  var res =  await detectBarcode(canvas);
  if(res.status == 'success') {
    var barcode = res.barcodes[0]
    if (barcode.format == 'qr_code'){
       myform.query.value = barcode.value
    }
    if (barcode.format == 'pdf417'){
      myform.query.value = barcode.value.FirstName + ' ' + barcode.value.LastName;
    }
    showMatches(myform.query.value);
  }
}
</script>
<?!=HtmlService.createHtmlOutputFromFile('barcode.js').getContent()?>

</html>