<!DOCTYPE html>
<html>

<head>
	<base target="_top">
</head>

<body>
	<script type="text/javascript" src="barcode.js"></script>
	<?var url = getScriptUrl();?>
	<a href='<?=url?>'>Home</a><br>
	<h1>New Registration</h1>
	<form id="myform" method="GET" action="<?=url?>">
		<input type="hidden" name="page" value="questionaire">
		<input type="hidden" name="action" value="register">
    <input type="hidden" name="dose" value="1">

		<h2>Patient Information</h2>
    <input type="hidden" name="ImageIDBackData">
		(optional) Scan State ID Barcode: <input type="file" accept="image/*"
      name="ImageIDBack" onchange="onImageChange(this,'canvas')" capture="environment">
		<canvas hidden id="canvas" width="0" height="0"></canvas><br>
      First Name: <input type="text" required name="FirstName"><br>
      Last Name: <input type="text" required name="LastName"><br>
      Date of Birth <input type="date" required name="DateOfBirth"><br>
      Gender: <select name="Gender">
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="other">Other</option>
      </select><br>
      Race:
		<select name="Race">
        <option value="White">White</option>
        <option value="BlackOrAfricanAmerican">Black or African American</option>
        <option value="AmericanIndianOrAlaskaNative">American Indian or Alaska Native</option>
        <option value="Asian">Asian</option>
        <option value="NativeHawaiianOrOtherPacificIslander">Native Hawaiian or Other Pacific Islander</option>
        <option value="Other">Other</option>
        <option value="DeclineToSpecify">Decline to Specify</option>
      </select><br>
      Ethnicity:
		<select name="Ethnicity">
        <option value="HispanicOrLatino">Hispanic or Latino</option>
        <option value="NonHispanicOrLatino">Non Hispanic or Latino</option>
        <option value="Other">Other</option>
        <option value="DeclineToSpecify">Decline to Specify</option>
      </select><br>
		<br>
		<h2>Parent/Gaurdian/Self</h2>
		What is your relationship to Patient? <select name="RelationshipToPatient">
        <option value="self">Self</option>
        <option value="gaurdian">Parent/Gaurdian</option>
      </select><br>
      If you are not the patient, enter your name: <input type="text" name="SignatureName"><br>
		<br>
		<b>Preferred Contact Infomation:</b><br>
      Phone: <input type="text" required name="Phone"><br>
      Email: <input type="text" name="Email"><br>
		<br>
		<b>Address:</b><br>
      Street: <input type="text" name="AddressStreet"><br>
      City: <input type="text" name="AddressCity"><br>
      State: <input type="text" name="AddressState"><br>
      Zip: <input type="text" name="AddressZip"><br>

		<br>
		<h2>Insurance:</h2>
		Do you have insurance?
		<select name="InsuranceType" onchange="onSelectInsurace(this)">
        <option disabled selected>--select--</option>
        <option value="Private">Yes (Private)</option>
        <option value="Medicare">Yes (Medicare)</option>
        <option value="None">No</option>
      </select><br>
		<div id='insuranceField'></div>
		<br>
      Any special notes?<br>
		<textarea name="Notes" rows="4" cols="50"></textarea><br>
    <input type="hidden" id="Browser" name="Browser" value="">

		<button type="submit">Submit</button>
		<button type="button"
      onclick="google.script.run.withSuccessHandler(onGenerate).generateRegistrationTest()">Generate</button>
		<button type="button" onclick="debugForm(this.parentNode)">Debug</button>
	</form>


<script>

document.getElementById("Browser").value = navigator.appVersion;

function debugForm(formObject) {
    for(var e in formObject.elements) {
      console.log(e);
    }
}

function base64EncodePhoto(elem) {
  const file = elem.files[0];
  const reader = new FileReader();
  reader.addEventListener("load", function () {
    // convert image file to base64 string
    document.getElementsByName(elem.name+'Data')[0].value = reader.result
  }, false);

  if (file) {
    reader.readAsDataURL(file);
  }
}

function onSelectInsurace(elem) {
  html = '';
  switch(elem.value) {
    case 'Private':
      html += `
<input type="hidden" name="ImageInsuranceFrontData">
Photo of FRONT: <input type="file" accept="image/*" name="ImageInsuranceFront" capture="environment" onchange="onImageChange(this,'canvas')"><br>
<input type="hidden" name="ImageInsuranceBackData">
Photo of BACK: <input type="file" accept="image/*" name="ImageInsuranceBack" capture="environment" onchange="onImageChange(this,'canvas')"><br>
Policy Holder Name: <input type='text' name='InsurancePolicyHolder'><br>
Policy Holder Date Of Birth: <input type='text' name='InsurancePolicyHolderDateOfBirth'><br>
Insurance Company: <input type='text' name='InsuranceCompany'><br>
Insurance Claim Address: <input type='text' name='InsuranceClaimAddress'><br>
Group Number: <input type='text' name='InsuranceGroupNumber'><br>
Subscriber ID: <input type='text' name='InsuranceSubscriberID'><br>
<input type='text' hidden name='InsuranceSSN'>
      `;
      break;
    case 'Medicare':
      html += `
Photo of FRONT:
<input type="hidden" name="ImageInsuranceFrontData">
<input type="file" accept="image/*" name="ImageInsuranceFront" capture="environment" onchange="onImageChange(this,'canvas')"><br>
Photo of BACK:
<input type="hidden" name="ImageInsuranceBackData">
<input type="file" accept="image/*" name="ImageInsuranceBack" capture="environment" onchange="onImageChange(this,'canvas')"><br>
Policy Holder: <input type='text' name='InsurancePolicyHolder'><br>
Policy Holder Date Of Birth: <input type='text' name='InsurancePolicyHolderDateOfBirth'><br>
<input type='text' name='InsuranceCompany' hidden value='Medicare'>
<input type='text' name='InsuranceClaimAddress' hidden value=''>
<input type='text' name='InsuranceGroupNumber' hidden value=''>
Subscriber ID: <input type='text' name='InsuranceSubscriberID'><br>
<input type='text' hidden name='InsuranceSSN'>

      `;
      break;
    default:
      html += `
<input type="hidden" name="ImageInsuranceFrontData">
<input type="file" accept="image/*" name="ImageInsuranceFront" capture="environment" hidden>
<input type="hidden" name="ImageInsuranceBackData">
<input type="file" accept="image/*" name="ImageInsuranceBack" capture="environment" hidden>
<input type='text' name='InsurancePolicyHolder' hidden value=''>
<input type='text' name='InsurancePolicyHolderDateOfBirth' hidden value=''>
<input type='text' name='InsuranceCompany' hidden value=''>
<input type='text' name='InsuranceClaimAddress' hidden value=''>
<input type='text' name='InsuranceGroupNumber' hidden value=''>
<input type='text' name='InsuranceSubscriberID' hidden value=''>
Social Security Number: <input type='text' name='InsuranceSSN'><br>
      `;
      break;
  }
  document.getElementById('insuranceField').innerHTML = html;
}

function onGenerate(record){
  //set insurance first to generate fields
  myform.InsuranceType.value = record.InsuranceType;

  onSelectInsurace(myform.InsuranceType);

  myform.FirstName.value = record.FirstName;
  myform.LastName.value = record.LastName;
  myform.DateOfBirth.value = record.DateOfBirth;
  myform.Phone.value = record.Phone;
  myform.Email.value = record.Email;
  myform.Gender.value = record.Gender;
  myform.Race.value = record.Race;
  myform.Ethnicity.value = record.Ethnicity;
  myform.RelationshipToPatient.value = record.RelationshipToPatient;
  myform.SignatureName.value = record.SignatureName;
  myform.AddressStreet.value = record.AddressStreet;
  myform.AddressCity.value = record.AddressCity;
  myform.AddressState.value = record.AddressState;
  myform.AddressZip.value = record.AddressZip;
  myform.InsurancePolicyHolder.value = record.InsurancePolicyHolder;
  myform.InsurancePolicyHolderDateOfBirth.value = record.InsurancePolicyHolderDateOfBirth;
  myform.InsuranceCompany.value = record.InsuranceCompany;
  myform.InsuranceClaimAddress.value = record.InsuranceClaimAddress;
  myform.InsuranceGroupNumber.value = record.InsuranceGroupNumber;
  myform.InsuranceSubscriberID.value = record.InsuranceSubscriberID;
  myform.InsuranceSSN.value = record.InsuranceSSN;
  myform.Notes.value = record.Notes;
}


// reads file into memory, draws scaled version to canvas, runs barcode detection on canvas, displays output
async function onImageChange(elem, canvasId){
  var canvas = document.getElementById(canvasId);
  await scaleImageToFit(elem,1000,canvas);
  var res =  await detectBarcode(canvas);
  if(res.status == 'success') {
    var barcode = res.barcodes[0]
    if (barcode.format == 'qr_code'){
    }
    if (barcode.format == 'pdf417'){
      // TODO add undefined checks
      myform.FirstName.value = (barcode.value.FirstName === undefined) ? '' : barcode.value.FirstName;
      myform.LastName.value = (barcode.value.LastName === undefined) ? '' : barcode.value.LastName;
      myform.DateOfBirth.value = (barcode.value.DateOfBirth === undefined) ? '' : barcode.value.DateOfBirth;
      myform.Gender.value = (barcode.value.Sex === undefined) ? '' : barcode.value.Sex;
      myform.AddressStreet.value = (barcode.value.AddressStreet1 === undefined) ? '' : barcode.value.AddressStreet1;
      myform.AddressCity.value = (barcode.value.AddressCity === undefined) ? '' : barcode.value.AddressCity;
      myform.AddressState.value = (barcode.value.AddressState === undefined) ? '' : barcode.value.AddressState;
      myform.AddressZip.value = (barcode.value.AddressZip === undefined) ? '' : barcode.value.AddressZip;
    }
  }
}

	</script>

  <?!=generateBarcodeJavascript()?>
</body>

</html>